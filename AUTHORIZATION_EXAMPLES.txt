ğŸ” MULTI-TENANT AUTHORIZATION EXAMPLES
========================================

This file demonstrates how the CompanyAccessGuard works in practice.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCENARIO 1: Regular User Accessing Their Own Company
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

User: john@example.com (role: USER)
User ID: 507f1f77bcf86cd799439011
Companies owned: [Company A: 607f1f77bcf86cd799439022]

Request: GET /companies/607f1f77bcf86cd799439022/products
Headers: Authorization: Bearer <john's-jwt-token>

CompanyAccessGuard Logic:
1. âœ… Extract user from JWT: john@example.com
2. âœ… Extract companyId from params: 607f1f77bcf86cd799439022
3. âœ… Query database: Find Company A
4. âœ… Check ownership: company.ownerId === user.userId â†’ TRUE
5. âœ… Result: ALLOWED (200 OK)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCENARIO 2: Regular User Accessing Another User's Company
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

User: john@example.com (role: USER)
User ID: 507f1f77bcf86cd799439011
Companies owned: [Company A: 607f1f77bcf86cd799439022]

Request: GET /companies/707f1f77bcf86cd799439033/products
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
          This is Company B owned by alice@example.com
Headers: Authorization: Bearer <john's-jwt-token>

CompanyAccessGuard Logic:
1. âœ… Extract user from JWT: john@example.com
2. âœ… Extract companyId from params: 707f1f77bcf86cd799439033
3. âœ… Query database: Find Company B
4. âŒ Check ownership: company.ownerId === user.userId â†’ FALSE
5. âŒ Check membership: user.userId in company.members â†’ FALSE
6. âŒ Result: FORBIDDEN (403)

Response:
{
  "statusCode": 403,
  "message": "Access denied: You do not have permission to access this company"
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCENARIO 3: Company Member Accessing Company Resources
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

User: bob@example.com (role: USER)
User ID: 807f1f77bcf86cd799439044
Companies owned: []
Member of: [Company A: 607f1f77bcf86cd799439022]

Request: GET /companies/607f1f77bcf86cd799439022/projects
Headers: Authorization: Bearer <bob's-jwt-token>

CompanyAccessGuard Logic:
1. âœ… Extract user from JWT: bob@example.com
2. âœ… Extract companyId from params: 607f1f77bcf86cd799439022
3. âœ… Query database: Find Company A
4. âŒ Check ownership: company.ownerId === user.userId â†’ FALSE
5. âœ… Check membership: user.userId in company.members â†’ TRUE
6. âœ… Result: ALLOWED (200 OK)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCENARIO 4: SuperAdmin Accessing Any Company
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

User: admin@system.com (role: SUPERADMIN)
User ID: 907f1f77bcf86cd799439055
Companies owned: []
Member of: []

Request: GET /companies/607f1f77bcf86cd799439022/offers
Headers: Authorization: Bearer <admin's-jwt-token>

CompanyAccessGuard Logic:
1. âœ… Extract user from JWT: admin@system.com
2. âœ… Check role: user.role === SUPERADMIN â†’ TRUE
3. âœ… Result: ALLOWED (200 OK) - Bypass all checks

Note: SuperAdmin can access ALL companies regardless of ownership/membership

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCENARIO 5: Creating Resources Within a Company
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

User: john@example.com (role: USER)
User ID: 507f1f77bcf86cd799439011
Companies owned: [Company A: 607f1f77bcf86cd799439022]

Request: POST /companies/607f1f77bcf86cd799439022/products
Headers: Authorization: Bearer <john's-jwt-token>
Body:
{
  "name": "New Laptop",
  "description": "Gaming laptop",
  "price": 1499.99
}

Flow:
1. âœ… CompanyAccessGuard validates access to Company A
2. âœ… ProductsController.create() receives the request
3. âœ… ProductsService creates product with companyId
4. âœ… Product is linked to Company A
5. âœ… Company A's products array is updated
6. âœ… Result: Product created (201 Created)

Database Changes:
- New Product document created with companyId: 607f1f77bcf86cd799439022
- Company A's products array: [..., newProductId]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCENARIO 6: Attempting to Create Resource in Wrong Company
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

User: john@example.com (role: USER)
User ID: 507f1f77bcf86cd799439011
Companies owned: [Company A: 607f1f77bcf86cd799439022]

Request: POST /companies/707f1f77bcf86cd799439033/products
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                        Company B (owned by Alice)
Headers: Authorization: Bearer <john's-jwt-token>
Body:
{
  "name": "Hacker Laptop",
  "description": "Trying to add to wrong company",
  "price": 9999.99
}

Flow:
1. âŒ CompanyAccessGuard validates access to Company B
2. âŒ Check fails: John is not owner or member
3. âŒ Result: FORBIDDEN (403)
4. âŒ Product is NEVER created

Security: The guard prevents the request from even reaching the service layer!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCENARIO 7: Member Management
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

User: john@example.com (role: USER)
User ID: 507f1f77bcf86cd799439011
Companies owned: [Company A: 607f1f77bcf86cd799439022]

Action: Add Bob as a member to Company A

Request: POST /companies/607f1f77bcf86cd799439022/members/807f1f77bcf86cd799439044
Headers: Authorization: Bearer <john's-jwt-token>

Flow:
1. âœ… Verify John is the owner of Company A
2. âœ… Add Bob's ID to Company A's members array
3. âœ… Add Company A's ID to Bob's companies array
4. âœ… Result: Bob can now access Company A resources

After this:
- Bob can GET/POST/PATCH/DELETE resources in Company A
- Bob CANNOT add/remove other members (only owner can)
- Bob CANNOT update company details (only owner can)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCENARIO 8: Invalid Company ID
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Request: GET /companies/invalid-id-format/products
Headers: Authorization: Bearer <valid-jwt-token>

CompanyAccessGuard Logic:
1. âœ… Extract companyId: "invalid-id-format"
2. âŒ Validate ObjectId format â†’ INVALID
3. âŒ Result: FORBIDDEN (403)

Response:
{
  "statusCode": 403,
  "message": "Invalid company ID format"
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCENARIO 9: Non-Existent Company
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Request: GET /companies/999f1f77bcf86cd799439999/products
         (Valid ObjectId format but company doesn't exist)
Headers: Authorization: Bearer <valid-jwt-token>

CompanyAccessGuard Logic:
1. âœ… Extract companyId: 999f1f77bcf86cd799439999
2. âœ… Validate ObjectId format â†’ VALID
3. âœ… Query database for company
4. âŒ Company not found in database
5. âŒ Result: FORBIDDEN (403)

Response:
{
  "statusCode": 403,
  "message": "Company not found"
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CODE IMPLEMENTATION REFERENCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

The CompanyAccessGuard (src/auth/guards/company-access.guard.ts):

@Injectable()
export class CompanyAccessGuard implements CanActivate {
  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest();
    const user = request.user;

    // 1. SuperAdmin bypass
    if (user.role === Role.SUPERADMIN) {
      return true;
    }

    // 2. Extract and validate companyId
    const companyId = request.params.companyId;
    if (!Types.ObjectId.isValid(companyId)) {
      throw new ForbiddenException('Invalid company ID format');
    }

    // 3. Check if company exists
    const company = await this.companyModel.findById(companyId).lean();
    if (!company) {
      throw new ForbiddenException('Company not found');
    }

    // 4. Check ownership
    if (company.ownerId.toString() === user.userId) {
      return true;
    }

    // 5. Check membership
    const isMember = company.members?.some(
      (memberId) => memberId.toString() === user.userId,
    );
    if (isMember) {
      return true;
    }

    // 6. Deny access
    throw new ForbiddenException(
      'Access denied: You do not have permission to access this company',
    );
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SECURITY BENEFITS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Data Isolation:
   - Users can only access their own company data
   - No cross-tenant data leakage

âœ… Guard-Level Protection:
   - Security enforced before reaching business logic
   - Prevents unauthorized database queries

âœ… Clear Access Rules:
   - Owner: Full control
   - Member: Can manage resources
   - SuperAdmin: System-wide access
   - Others: No access

âœ… Consistent Enforcement:
   - Applied to all company-scoped routes
   - Single point of authorization logic

âœ… Performance:
   - Efficient database queries with indexes
   - Single query to check company access

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

This pattern is used in production SaaS applications worldwide! ğŸš€

